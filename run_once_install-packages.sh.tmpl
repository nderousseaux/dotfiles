#!/bin/bash
# chezmoi run_once script ‚Äî ex√©cut√© une seule fois par machine
# Installe les d√©pendances essentielles

set -euo pipefail

echo "üöÄ Installation des outils de base..."

{{ if eq .chezmoi.os "darwin" -}}
# ============================================
# macOS ‚Äî Homebrew
# ============================================
if ! command -v brew &>/dev/null; then
    echo "üì¶ Installation de Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

echo "üì¶ Installation des paquets Homebrew..."
brew install --quiet \
    fzf \
    bat \
    eza \
    tmux \
    tldr \
    autojump \
    git-lfs \
    bpytop

# Oh-My-Zsh
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "üêö Installation de Oh-My-Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Plugins zsh
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
fi
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions.git "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
fi

# TPM (Tmux Plugin Manager)
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    echo "üì¶ Installation de TPM..."
    git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
fi

# Vim-Plug
if [ ! -f "$HOME/.vim/autoload/plug.vim" ]; then
    echo "üì¶ Installation de vim-plug..."
    curl -fLo "$HOME/.vim/autoload/plug.vim" --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
fi

{{ else if eq .chezmoi.os "linux" -}}
# ============================================
# Linux ‚Äî apt (Debian/Ubuntu)
# ============================================
if command -v apt &>/dev/null; then
    echo "üì¶ Mise √† jour et installation des paquets..."
    sudo apt update -qq
    sudo apt install -y -qq \
        fzf \
        bat \
        tmux \
        tldr \
        autojump \
        git-lfs \
        bpytop \
        vim
fi

# Oh-My-Zsh
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "üêö Installation de Oh-My-Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Plugins zsh
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
fi
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions.git "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
fi

# TPM
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
fi

# Vim-Plug
if [ ! -f "$HOME/.vim/autoload/plug.vim" ]; then
    curl -fLo "$HOME/.vim/autoload/plug.vim" --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
fi

{{ end -}}

# Git hooks template
echo "üîó Installation des git hooks..."
git config --global init.templateDir "$HOME/.config/git/template"

echo "‚úÖ Installation termin√©e !"
